<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .test-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 15px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
    }

    .question-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .question-number {
      font-size: 12px;
      color: #667eea;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .question-text {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .answers-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .answer-option {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 15px;
      background: #f9f9f9;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .answer-option:hover {
      border-color: #667eea;
      background: #f5f7ff;
    }

    .answer-option input[type="radio"] {
      cursor: pointer;
      margin-top: 3px;
    }

    .answer-text {
      flex: 1;
      font-size: 14px;
      color: #333;
      line-height: 1.4;
    }

    .buttons-container {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }

    .btn-secondary:hover {
      background: #f5f7ff;
      transform: translateY(-2px);
    }

    .loading {
      text-align: center;
      padding: 40px 20px;
      background: white;
      border-radius: 15px;
      color: #999;
    }

    .spinner {
      border: 4px solid #f0f0f0;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: white;
      border-radius: 15px;
      padding: 40px 20px;
      text-align: center;
      color: #c33;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .error-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .results-container {
      background: white;
      border-radius: 15px;
      padding: 30px 20px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      animation: slideIn 0.5s ease-out;
    }

    .results-icon {
      font-size: 60px;
      margin-bottom: 20px;
    }

    .results-title {
      font-size: 22px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
    }

    .results-score {
      font-size: 32px;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 10px;
    }

    .results-details {
      font-size: 14px;
      color: #666;
      margin-bottom: 20px;
    }

    .name-input-section {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      text-align: left;
    }

    .name-input-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
    }

    .name-input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .name-input-group input {
      flex: 1;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }

    .name-options {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .name-option {
      flex: 1;
      padding: 10px;
      border: 2px solid #e0e0e0;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: #667eea;
      transition: all 0.3s;
      text-align: center;
    }

    .name-option:hover {
      border-color: #667eea;
      background: #f5f7ff;
    }

    .name-option.selected {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="loadingContainer" class="loading" style="display: none;">
      <div class="spinner"></div>
      <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–∞...</p>
    </div>

    <div id="errorContainer" class="error" style="display: none;">
      <div class="error-icon">‚ùå</div>
      <div id="errorText"></div>
    </div>

    <div id="testContainer" style="display: none;">
      <div class="header">
        <div class="test-title" id="testTitle"></div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div style="font-size: 12px; color: #999; margin-top: 8px;" id="progressText"></div>
      </div>

      <form id="testForm">
        <div id="questionsContainer"></div>

        <div class="buttons-container">
          <button type="submit" class="btn btn-primary" id="submitBtn">
            ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç
          </button>
        </div>
      </form>
    </div>

    <div id="resultsContainer" style="display: none;">
      <div class="results-container">
        <div class="results-icon">üéâ</div>
        <div class="results-title">–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!</div>
        <div class="results-score" id="scoreDisplay"></div>
        <div class="results-details" id="scoreDetails"></div>

        <div class="name-input-section">
          <label class="name-input-label">–ö–∞–∫ –≤–∞—Å –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å —Å–æ–∑–¥–∞—Ç–µ–ª—é —Ç–µ—Å—Ç–∞?</label>

          <div class="name-input-group">
            <input
              type="text"
              id="displayName"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–ª–∏ –Ω–∏–∫–Ω–µ–π–º"
              maxlength="50"
            >
          </div>

          <div class="name-options">
            <button
              type="button"
              class="name-option selected"
              id="useNameBtn"
              onclick="app.selectNameOption('name')"
            >
              üë§ –í–≤–µ—Å—Ç–∏ –∏–º—è
            </button>
            <button
              type="button"
              class="name-option"
              id="useUsernameBtn"
              onclick="app.selectNameOption('username')"
            >
              üîê –û—Å—Ç–∞—Ç—å—Å—è –∞–Ω–æ–Ω–∏–º–Ω—ã–º
            </button>
          </div>
        </div>

        <button class="btn btn-primary" id="finishBtn" style="width: 100%;">
          ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å
        </button>
      </div>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const API_URL = window.location.origin;

    // Initialize Telegram Web App
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.ready();
    }

    // Parse testId from URL or initData
    let testId = null;
    const params = new URLSearchParams(window.location.search);
    const initData = tg?.initData || '';

    // Try to get test_id from URL first
    testId = params.get('test_id');

    // If not in URL, try to get from startapp parameter
    if (!testId && initData) {
      const urlParams = new URLSearchParams(initData);
      const startApp = urlParams.get('start_param');
      if (startApp && startApp.startsWith('test_')) {
        testId = startApp.substring(5); // Remove 'test_' prefix
      }
    }

    class TakeTestPage {
      constructor() {
        this.test = null;
        this.answers = {};
        this.currentNameOption = 'name';
        this.telegramUser = tg?.initDataUnsafe?.user || null;
        this.init();
      }

      async init() {
        try {
          document.getElementById('loadingContainer').style.display = 'block';
          await this.loadTest();
          document.getElementById('loadingContainer').style.display = 'none';
          this.renderTest();
          this.setupEventListeners();
        } catch (error) {
          console.error('Init error:', error);
          document.getElementById('loadingContainer').style.display = 'none';
          this.showError(error.message);
        }
      }

      async loadTest() {
        if (!testId) {
          throw new Error('ID —Ç–µ—Å—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }

        if (!this.telegramUser) {
          throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram');
        }

        const response = await fetch(`${API_URL}/api/tests/${testId}`);

        if (!response.ok) {
          const data = await response.json();
          if (response.status === 404) {
            throw new Error('–¢–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
          }
          throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–∞');
        }

        this.test = await response.json();

        // Check authorization - sync current user
        const userResponse = await fetch(`${API_URL}/api/users/me`, {
          headers: {
            'x-telegram-id': this.telegramUser.id.toString(),
          },
        });

        if (!userResponse.ok) {
          throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }

        const user = await userResponse.json();

        // Check if user is creator
        if (this.test.creator_id === user.id) {
          throw new Error('–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç');
        }

        // Check if already attempted
        const attempts = await fetch(`${API_URL}/api/tests/${testId}/attempts`);
        const attemptsList = await attempts.json();
        const userAttempt = attemptsList.find((a) => a.user_id === user.id);

        if (userAttempt) {
          throw new Error('–í—ã —É–∂–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —ç—Ç–æ—Ç —Ç–µ—Å—Ç');
        }
      }

      renderTest() {
        document.getElementById('testTitle').textContent = this.test.title;
        document.getElementById('testContainer').style.display = 'block';

        const container = document.getElementById('questionsContainer');
        const totalQuestions = this.test.questions?.length || 0;

        container.innerHTML = (this.test.questions || [])
          .map((question, qIndex) => `
            <div class="question-card">
              <div class="question-number">–í–æ–ø—Ä–æ—Å ${qIndex + 1} –∏–∑ ${totalQuestions}</div>
              <div class="question-text">${this.escapeHtml(question.text)}</div>

              <div class="answers-list">
                ${(question.answers || [])
                  .map(
                    (answer) => `
                  <label class="answer-option">
                    <input
                      type="radio"
                      name="question-${question.id}"
                      value="${answer.id}"
                      onchange="app.selectAnswer('${question.id}', '${answer.id}')"
                    >
                    <span class="answer-text">${this.escapeHtml(answer.text)}</span>
                  </label>
                `
                  )
                  .join('')}
              </div>
            </div>
          `)
          .join('');
      }

      selectAnswer(questionId, answerId) {
        this.answers[questionId] = answerId;
        this.updateProgress();
      }

      updateProgress() {
        const totalQuestions = this.test.questions?.length || 0;
        const answeredQuestions = Object.keys(this.answers).length;
        const percentage = Math.round((answeredQuestions / totalQuestions) * 100);

        document.getElementById('progressFill').style.width = `${percentage}%`;
        document.getElementById('progressText').textContent = `${answeredQuestions} –∏–∑ ${totalQuestions} –≤–æ–ø—Ä–æ—Å–æ–≤`;

        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = answeredQuestions < totalQuestions;
      }

      async submitAnswers() {
        try {
          const totalQuestions = this.test.questions?.length || 0;
          const answeredQuestions = Object.keys(this.answers).length;

          if (answeredQuestions < totalQuestions) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã');
            return;
          }

          document.getElementById('submitBtn').disabled = true;

          const response = await fetch(`${API_URL}/api/test-attempts`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-telegram-id': this.telegramUser.id.toString(),
            },
            body: JSON.stringify({
              testId,
              answers: this.answers,
              displayName: null,
            }),
          });

          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤');
          }

          const attempt = await response.json();

          // Show results
          document.getElementById('testContainer').style.display = 'none';
          document.getElementById('resultsContainer').style.display = 'block';

          const percentage = attempt.percentage;
          const score = attempt.score;
          const total = attempt.total_questions;

          document.getElementById('scoreDisplay').textContent = `${percentage}%`;
          document.getElementById('scoreDetails').textContent = `–í—ã –æ—Ç–≤–µ—Ç–∏–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞ ${score} –∏–∑ ${total} –≤–æ–ø—Ä–æ—Å–æ–≤`;

          this.attempt = attempt;
          this.setupResultsEventListeners();
        } catch (error) {
          console.error('Submit error:', error);
          alert(error.message);
          document.getElementById('submitBtn').disabled = false;
        }
      }

      selectNameOption(option) {
        this.currentNameOption = option;

        document.getElementById('useNameBtn').classList.remove('selected');
        document.getElementById('useUsernameBtn').classList.remove('selected');

        if (option === 'name') {
          document.getElementById('useNameBtn').classList.add('selected');
          document.getElementById('displayName').style.display = 'block';
          document.getElementById('displayName').placeholder = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–ª–∏ –Ω–∏–∫–Ω–µ–π–º';
        } else {
          document.getElementById('useUsernameBtn').classList.add('selected');
          document.getElementById('displayName').value = '';
        }
      }

      async finishTest() {
        try {
          let displayName = null;

          if (this.currentNameOption === 'name') {
            displayName = document.getElementById('displayName').value.trim();
            if (!displayName) {
              alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è');
              return;
            }
          }

          // Update attempt with display name if needed
          // For now, we just go back since the attempt was already created
          alert('‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞!');
          // Close the Web App and return to main menu
          if (tg) {
            tg.close();
          } else {
            window.location.href = `/miniapp`;
          }
        } catch (error) {
          console.error('Finish error:', error);
          alert('–û—à–∏–±–∫–∞');
        }
      }

      setupEventListeners() {
        document.getElementById('testForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.submitAnswers();
        });
      }

      setupResultsEventListeners() {
        document.getElementById('finishBtn').addEventListener('click', () => {
          this.finishTest();
        });
      }

      showError(message) {
        document.getElementById('loadingContainer').style.display = 'none';
        document.getElementById('testContainer').style.display = 'none';
        document.getElementById('resultsContainer').style.display = 'none';
        document.getElementById('errorContainer').style.display = 'block';
        document.getElementById('errorText').innerHTML = `
          <div style="font-size: 16px; margin-bottom: 15px;">${message}</div>
          <button class="btn btn-secondary" style="width: 100%;" onclick="window.history.back()">
            ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è
          </button>
        `;
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    }

    const app = new TakeTestPage();
  </script>
</body>
</html>
