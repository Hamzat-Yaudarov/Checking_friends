<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      padding: 25px;
      animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header {
      display: flex;
      align-items: center;
      margin-bottom: 30px;
      gap: 10px;
    }

    .back-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
    }

    .title {
      font-size: 24px;
      font-weight: 600;
      color: #333;
      flex: 1;
    }

    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .spinner {
      border: 4px solid #f0f0f0;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus,
    textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #667eea;
      margin-top: 30px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .question-card {
      background: #f9f9f9;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .question-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .question-number {
      font-size: 12px;
      background: #667eea;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: 600;
    }

    .delete-btn {
      background: #ffebee;
      color: #c33;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .delete-btn:hover {
      background: #ffcdd2;
    }

    .question-text {
      font-size: 14px;
      color: #333;
      margin-bottom: 12px;
      word-break: break-word;
    }

    .answer-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }

    .answer-item input[type="radio"] {
      margin-top: 6px;
      cursor: pointer;
    }

    .answer-item input[type="text"] {
      flex: 1;
      padding: 8px;
      font-size: 13px;
    }

    .answer-delete {
      background: #ffebee;
      color: #c33;
      border: none;
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }

    .answer-delete:hover {
      background: #ffcdd2;
    }

    .add-answer-btn {
      background: #e3f2fd;
      color: #1976d2;
      border: 1px dashed #1976d2;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      width: 100%;
      transition: all 0.3s;
      margin-top: 10px;
    }

    .add-answer-btn:hover {
      background: #bbdefb;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 30px;
    }

    .btn {
      padding: 14px 20px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      flex: 1;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .add-question-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px;
      border: none;
      border-radius: 10px;
      width: 100%;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 20px;
      transition: all 0.3s;
    }

    .add-question-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      text-align: center;
    }

    .success {
      background: #efe;
      color: #3c3;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <button class="back-btn" id="backBtn">‚Üê</button>
      <div class="title">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
    </div>

    <div id="message"></div>

    <div id="loadingContainer" class="loading" style="display: none;">
      <div class="spinner"></div>
      <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>

    <form id="testForm" style="display: none;">
      <div class="form-group">
        <label for="testTitle">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞ *</label>
        <input type="text" id="testTitle" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ..." required>
      </div>

      <div class="form-group">
        <label for="testDescription">–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
        <textarea id="testDescription" placeholder="–î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞..."></textarea>
      </div>

      <div class="section-title">üìù –í–æ–ø—Ä–æ—Å—ã</div>

      <div id="questionsContainer"></div>

      <button type="button" class="add-question-btn" id="addQuestionBtn">
        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å
      </button>

      <div class="action-buttons">
        <button type="submit" class="btn btn-primary" id="submitBtn">
          ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
        </button>
        <button type="button" class="btn btn-secondary" id="cancelBtn">
          ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å
        </button>
      </div>
    </form>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const API_URL = window.location.origin;

    // Initialize Telegram Web App
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.ready();
    }

    const params = new URLSearchParams(window.location.search);
    const testId = params.get('test_id');
    let telegramId = params.get('user_id');

    // If not in URL, get from Telegram Web App API
    if (!telegramId && tg?.initDataUnsafe?.user) {
      telegramId = tg.initDataUnsafe.user.id;
    }

    class EditTestPage {
      constructor() {
        this.test = null;
        this.questions = [];
        this.init();
      }

      async init() {
        try {
          document.getElementById('loadingContainer').style.display = 'block';
          await this.loadTest();
          document.getElementById('loadingContainer').style.display = 'none';
          document.getElementById('testForm').style.display = 'block';
          this.renderTest();
          this.setupEventListeners();
        } catch (error) {
          console.error('Init error:', error);
          this.showMessage(error.message, 'error');
        }
      }

      async loadTest() {
        const response = await fetch(`${API_URL}/api/tests/${testId}`);

        if (!response.ok) {
          throw new Error('–¢–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }

        this.test = await response.json();
        this.questions = JSON.parse(JSON.stringify(this.test.questions || []));

        document.getElementById('testTitle').value = this.test.title;
        document.getElementById('testDescription').value = this.test.description || '';
      }

      renderTest() {
        this.renderQuestions();
      }

      renderQuestions() {
        const container = document.getElementById('questionsContainer');

        container.innerHTML = this.questions
          .map((question, qIndex) => `
            <div class="question-card">
              <div class="question-header">
                <span class="question-number">–í–æ–ø—Ä–æ—Å ${qIndex + 1}</span>
                <button type="button" class="delete-btn" onclick="app.deleteQuestion(${qIndex})">
                  üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                </button>
              </div>

              <div class="form-group">
                <input
                  type="text"
                  placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å..."
                  value="${question.text}"
                  onchange="app.updateQuestionText(${qIndex}, this.value)"
                  style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px;"
                >
              </div>

              <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #666;">–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤:</label>
              ${(question.answers || [])
                .map(
                  (answer, aIndex) => `
                <div class="answer-item">
                  <input
                    type="radio"
                    name="correct-${qIndex}"
                    ${answer.is_correct ? 'checked' : ''}
                    onchange="app.setCorrectAnswer(${qIndex}, ${aIndex})"
                  >
                  <input
                    type="text"
                    placeholder="–í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ ${aIndex + 1}"
                    value="${answer.text}"
                    onchange="app.updateAnswerText(${qIndex}, ${aIndex}, this.value)"
                  >
                  <button type="button" class="answer-delete" onclick="app.deleteAnswer(${qIndex}, ${aIndex})">
                    ‚úï
                  </button>
                </div>
              `
                )
                .join('')}

              <button type="button" class="add-answer-btn" onclick="app.addAnswer(${qIndex})">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞
              </button>
            </div>
          `)
          .join('');
      }

      addQuestion() {
        this.questions.push({
          id: `q-${Date.now()}`,
          text: '',
          answers: [
            { id: `a-${Date.now()}-0`, text: '', is_correct: true },
            { id: `a-${Date.now()}-1`, text: '', is_correct: false },
          ],
        });
        this.renderQuestions();
      }

      deleteQuestion(qIndex) {
        this.questions.splice(qIndex, 1);
        this.renderQuestions();
      }

      addAnswer(qIndex) {
        this.questions[qIndex].answers.push({
          id: `a-${Date.now()}`,
          text: '',
          is_correct: false,
        });
        this.renderQuestions();
      }

      deleteAnswer(qIndex, aIndex) {
        this.questions[qIndex].answers.splice(aIndex, 1);
        this.renderQuestions();
      }

      updateQuestionText(qIndex, text) {
        this.questions[qIndex].text = text;
      }

      updateAnswerText(qIndex, aIndex, text) {
        this.questions[qIndex].answers[aIndex].text = text;
      }

      setCorrectAnswer(qIndex, aIndex) {
        this.questions[qIndex].answers.forEach((a, idx) => {
          a.is_correct = idx === aIndex;
        });
      }

      async saveTest() {
        try {
          const title = document.getElementById('testTitle').value.trim();
          const description = document.getElementById('testDescription').value.trim();

          if (!title) {
            this.showMessage('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞', 'error');
            return;
          }

          if (this.questions.length === 0) {
            this.showMessage('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å', 'error');
            return;
          }

          for (const question of this.questions) {
            if (!question.text.trim()) {
              this.showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤—Å–µ—Ö –≤–æ–ø—Ä–æ—Å–æ–≤', 'error');
              return;
            }

            if (question.answers.length < 2) {
              this.showMessage('–ö–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –º–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞', 'error');
              return;
            }

            if (!question.answers.some((a) => a.text.trim())) {
              this.showMessage('–í—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω—ã', 'error');
              return;
            }

            if (!question.answers.some((a) => a.is_correct)) {
              this.showMessage('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞', 'error');
              return;
            }
          }

          document.getElementById('submitBtn').disabled = true;
          this.showMessage('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...', 'loading');

          // Update test
          await fetch(`${API_URL}/api/tests/${testId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'x-telegram-id': telegramId,
            },
            body: JSON.stringify({
              title,
              description: description || null,
            }),
          });

          // Delete all existing questions
          for (const question of this.test.questions || []) {
            await fetch(`${API_URL}/api/questions/${question.id}`, {
              method: 'DELETE',
              headers: {
                'x-telegram-id': telegramId,
              },
            });
          }

          // Create new questions
          for (let qIndex = 0; qIndex < this.questions.length; qIndex++) {
            const question = this.questions[qIndex];

            const questionResponse = await fetch(`${API_URL}/api/questions`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-telegram-id': telegramId,
              },
              body: JSON.stringify({
                testId,
                text: question.text.trim(),
                orderIndex: qIndex,
              }),
            });

            const createdQuestion = await questionResponse.json();

            for (let aIndex = 0; aIndex < question.answers.length; aIndex++) {
              const answer = question.answers[aIndex];

              await fetch(`${API_URL}/api/answers`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'x-telegram-id': telegramId,
                },
                body: JSON.stringify({
                  questionId: createdQuestion.id,
                  text: answer.text.trim(),
                  isCorrect: answer.is_correct,
                  orderIndex: aIndex,
                }),
              });
            }
          }

          this.showMessage('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
          setTimeout(() => {
            window.location.href = `/miniapp/my-tests?user_id=${telegramId}`;
          }, 1500);
        } catch (error) {
          console.error('Save test error:', error);
          this.showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç–µ—Å—Ç–∞', 'error');
          document.getElementById('submitBtn').disabled = false;
        }
      }

      showMessage(text, type) {
        const messageEl = document.getElementById('message');
        messageEl.className = type;
        messageEl.textContent = text;
        messageEl.style.display = 'block';
      }

      setupEventListeners() {
        document.getElementById('addQuestionBtn').addEventListener('click', (e) => {
          e.preventDefault();
          this.addQuestion();
        });

        document.getElementById('testForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.saveTest();
        });

        document.getElementById('backBtn').addEventListener('click', () => {
          window.history.back();
        });

        document.getElementById('cancelBtn').addEventListener('click', () => {
          window.history.back();
        });
      }
    }

    const app = new EditTestPage();
  </script>
</body>
</html>
